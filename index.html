<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>capture microphone audio into buffer</title>
</head>
<body>
  <script
    src="https://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
  <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  <script type="text/javascript" src="src/recorder.js"></script>
  <script>
    // Get all the babel scripts
    var babel_scripts = document.querySelectorAll('script[type="text/babel"]');

    // Loop over them
    Array.prototype.forEach.call(babel_scripts, function (script, index, arr) {
      jQuery.get(script.src, function(input) {
        var output = Babel.transform( input, { presets: ['es2015', 'react'] }).code;
        // Create a new script tag of `javascript` type
        var new_script = document.createElement('script');
        new_script.setAttribute('type', 'text/javascript');
        // Set the contents of the script to the transpiled code
        new_script.textContent = output;

        // Remove the babel script
        script.remove();
        // Inject the new transpiled JS
        document.querySelector('body').appendChild(new_script);
      });
    });
  </script>
  <script type="text/babel" src="http://localhost:8000/src/turtlegraphics.js"></script>
  <script type="text/babel" src="http://localhost:8000/src/command_processor.js"></script>

  <script type="text/javascript">
    var audioContext = new AudioContext;
    var recorder = null;

    function startUserMedia(stream) {
       var input = audioContext.createMediaStreamSource(stream);
       console.log('Media stream created.');

       recorder = new Recorder(input, {numChannels: 1});
       console.log('Recorder initialised.');
    }

    navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
      console.log('No live audio input: ' + e);
    });

    $(document).ready(function() {
      $("#record").click(function() {
        var recordBtn = $("#record");
        var text = recordBtn.val();
        if (text === "Record") {
          recordBtn.val("Execute");

          recorder && recorder.clear()
          recorder && recorder.record();
        } else {
          recordBtn.val("Record");
          recorder && recorder.stop();
          recognizeAndExecute();
        }
      });

      var recognizeAndExecute = function() {
        recorder && recorder.exportWAV(function(blob) {
          var oReq = new XMLHttpRequest();
          oReq.open("POST", "http://localhost:4567/audio", true);
          oReq.onload = function (oEvent) {
            // Uploaded.
            console.log(oEvent);
          };

          oReq.onreadystatechange = function() {
            if (oReq.readyState == XMLHttpRequest.DONE) {
              var response = JSON.parse(oReq.response)
              var translation = response.results[0].alternatives[0];
              $("#recognize-response").html(translation.transcript);

              var processor = new CommandProcessor();
              var preparedCommand = processor.process(translation.transcript);
              $("#prepared-response").html(preparedCommand);

              turtleInterpreter.execute(preparedCommand);
            }
          }

          oReq.onerror = function (error) {
            console.log(error);
          }

          oReq.send(blob);
        });
      }
    });
  </script>
    <input id="record" type="button" value="Record"/>
    <div><span><strong>Recognized </strong></span><span id="recognize-response"></span></div>
    <div><span><strong>Processed </strong></span><span id="prepared-response"></span></div>
    <div><canvas id="turtle" width='800' height='600' border='1px'></canvas></div>
</body>
</html>

