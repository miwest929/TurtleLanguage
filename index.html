<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
  <title>capture microphone audio into buffer</title>
</head>
<body>
  <script
    src="https://code.jquery.com/jquery-3.2.1.min.js"
    integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
    crossorigin="anonymous"></script>
  <script type="text/javascript" src="recorder.js"></script>
  <script type="text/javascript" src="microphone_capture.js"></script>
  <script type="text/javascript">
    //var microphone = new MicrophoneCapture();
    //microphone.openMic();
    var audioContext = new AudioContext;
    var rec = null;

    function startUserMedia(stream) {
       var input = audioContext.createMediaStreamSource(stream);
       console.log('Media stream created.');

       recorder = new Recorder(input, {numChannels: 1});
       console.log('Recorder initialised.');
    }

    navigator.getUserMedia({audio: true}, startUserMedia, function(e) {
      console.log('No live audio input: ' + e);
    });

    $(document).ready(function() {
      $("#record").click(function() {
        var recordBtn = $("#record");
        var text = recordBtn.val();
        if (text === "Record") {
          recordBtn.val("Stop");
          //microphone.startRecording();
           recorder && recorder.record();
        } else {
          recordBtn.val("Record");
          recorder && recorder.stop();
          //microphone.stopRecording();
        }
      });

      $("#play").click(function() {
        //microphone.playRecording();
      });

      $("#recognize").click(function() {
          recorder && recorder.exportWAV(function(blob) {
          var oReq = new XMLHttpRequest();
          oReq.open("POST", "http://localhost:3001/audio", true);
          oReq.onload = function (oEvent) {
            console.log(oEvent);
            // Uploaded.
          };
          oReq.onerror = function (error) {
            console.log(error);
          }

          console.log(blob);
          oReq.send(blob);
            /*$.ajax({
              type: "POST",
              contentType: 'application/octet-stream',
              url: "localhost:3001/audio",
              data: blob,
              success: function(data) { console.log("success"); }
            });*/
          });
/*        var recordingBuffer = microphone.getLastRecording();

        $.ajax({
          type: "POST",
          url: "/audio",
          data: {
           audio: recordingBuffer
          }*/
      });
    });
  </script>
    <input id="record" type="button" value="Record"/>
    <input id="play" type="button" value="Play"/>
    <input id="recognize" type="button" value="Recognize"/>
</body>
</html>

